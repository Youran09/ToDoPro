//
//  WorkingContentView.swift
//  ToDoPro
//
//  Created by Youran Tao Jensen on 01/10/2025.
//

import SwiftUI

struct WorkingContentView: View {
    @StateObject private var taskManager = TaskManager()
    @State private var showingAddTask = false
    @State private var selectedTab = 0

    var body: some View {
        TabView(selection: $selectedTab) {
            // Home Tab
            HomeView(taskManager: taskManager, showingAddTask: $showingAddTask)
                .tabItem {
                    Image(systemName: "house.fill")
                    Text("首页")
                }
                .tag(0)

            // Tasks Tab
            TasksListView(taskManager: taskManager)
                .tabItem {
                    Image(systemName: "list.bullet")
                    Text("任务")
                }
                .tag(1)

            // Analytics Tab
            AnalyticsView(taskManager: taskManager)
                .tabItem {
                    Image(systemName: "chart.bar")
                    Text("分析")
                }
                .tag(2)
        }
        .sheet(isPresented: $showingAddTask) {
            WorkingAddTaskView(taskManager: taskManager)
        }
    }
}

struct HomeView: View {
    @ObservedObject var taskManager: TaskManager
    @Binding var showingAddTask: Bool

    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 24) {
                    // Header
                    VStack(spacing: 8) {
                        Text("ToDoPro")
                            .font(.largeTitle)
                            .fontWeight(.bold)

                        Text("高效任务管理")
                            .font(.subheadline)
                            .foregroundColor(.secondary)
                    }
                    .padding(.top)

                    // Quick Stats
                    LazyVGrid(columns: [
                        GridItem(.flexible()),
                        GridItem(.flexible())
                    ], spacing: 16) {
                        StatCard(
                            title: "今日任务",
                            value: "\(taskManager.getTasksForToday().count)",
                            color: .blue,
                            icon: "calendar"
                        )

                        StatCard(
                            title: "剩余工作",
                            value: taskManager.todaysRemainingWorkload.shortFormattedTime,
                            color: .orange,
                            icon: "clock"
                        )

                        StatCard(
                            title: "已完成",
                            value: "\(taskManager.dailyStats.totalTasksCompleted)",
                            color: .green,
                            icon: "checkmark.circle"
                        )

                        StatCard(
                            title: "生产力",
                            value: "\(Int(taskManager.dailyStats.productivityScore))",
                            color: .purple,
                            icon: "chart.line.uptrend.xyaxis"
                        )
                    }

                    // Active Task
                    if let activeTask = taskManager.currentActiveTask {
                        ActiveTaskCard(task: activeTask, taskManager: taskManager)
                    }

                    // Recent Tasks
                    RecentTasksList(taskManager: taskManager)

                    // Add Task Button
                    Button(action: {
                        showingAddTask = true
                    }) {
                        HStack {
                            Image(systemName: "plus")
                            Text("添加新任务")
                        }
                        .frame(maxWidth: .infinity)
                        .padding()
                        .background(.blue)
                        .foregroundColor(.white)
                        .cornerRadius(12)
                    }

                    Spacer(minLength: 100)
                }
                .padding()
            }
            .navigationTitle("")
        }
    }
}

struct StatCard: View {
    let title: String
    let value: String
    let color: Color
    let icon: String

    var body: some View {
        VStack(spacing: 8) {
            Image(systemName: icon)
                .font(.title2)
                .foregroundColor(color)

            Text(value)
                .font(.headline)
                .fontWeight(.bold)

            Text(title)
                .font(.caption)
                .foregroundColor(.secondary)
        }
        .frame(maxWidth: .infinity)
        .padding()
        .background(color.opacity(0.1))
        .cornerRadius(12)
    }
}

struct ActiveTaskCard: View {
    let task: TodoTask
    @ObservedObject var taskManager: TaskManager

    var body: some View {
        VStack(spacing: 12) {
            HStack {
                Text("正在进行")
                    .font(.headline)
                    .fontWeight(.semibold)

                Spacer()

                Image(systemName: "timer")
                    .foregroundColor(.orange)
            }

            VStack(spacing: 8) {
                Text(task.title)
                    .font(.title3)
                    .fontWeight(.medium)

                Text(task.remainingTime.formattedTime)
                    .font(.title)
                    .fontWeight(.bold)
                    .foregroundColor(.orange)

                ProgressView(value: task.progress)
                    .tint(.orange)

                HStack(spacing: 16) {
                    Button(action: {
                        if task.status == .inProgress {
                            taskManager.pauseTask(task.id)
                        } else {
                            taskManager.resumeTask(task.id)
                        }
                    }) {
                        HStack {
                            Image(systemName: task.status == .inProgress ? "pause.fill" : "play.fill")
                            Text(task.status == .inProgress ? "暂停" : "继续")
                        }
                        .padding(.horizontal, 20)
                        .padding(.vertical, 8)
                        .background(.orange.opacity(0.2))
                        .foregroundColor(.orange)
                        .cornerRadius(20)
                    }

                    Button(action: {
                        taskManager.completeTask(task.id)
                    }) {
                        HStack {
                            Image(systemName: "checkmark")
                            Text("完成")
                        }
                        .padding(.horizontal, 20)
                        .padding(.vertical, 8)
                        .background(.green.opacity(0.2))
                        .foregroundColor(.green)
                        .cornerRadius(20)
                    }
                }
            }
        }
        .padding()
        .background(.orange.opacity(0.05))
        .cornerRadius(16)
    }
}

struct RecentTasksList: View {
    @ObservedObject var taskManager: TaskManager

    var recentTasks: [TodoTask] {
        Array(taskManager.tasks
            .filter { !$0.isArchived }
            .sorted { $0.createdDate > $1.createdDate }
            .prefix(3))
    }

    var body: some View {
        VStack(spacing: 12) {
            HStack {
                Text("最近任务")
                    .font(.headline)
                    .fontWeight(.semibold)

                Spacer()
            }

            if recentTasks.isEmpty {
                Text("还没有任务")
                    .foregroundColor(.secondary)
                    .padding()
            } else {
                VStack(spacing: 8) {
                    ForEach(recentTasks) { task in
                        TaskRow(task: task, taskManager: taskManager)
                    }
                }
            }
        }
    }
}

struct TaskRow: View {
    let task: TodoTask
    @ObservedObject var taskManager: TaskManager

    var body: some View {
        HStack(spacing: 12) {
            Circle()
                .fill(task.status.color)
                .frame(width: 8, height: 8)

            VStack(alignment: .leading, spacing: 2) {
                Text(task.title)
                    .font(.subheadline)
                    .fontWeight(.medium)

                HStack(spacing: 8) {
                    Text(task.estimatedDuration.shortFormattedTime)
                        .font(.caption)
                        .foregroundColor(.secondary)

                    if task.repeatType != .none {
                        Text("• \(task.repeatType.displayName)")
                            .font(.caption)
                            .foregroundColor(.blue)
                    }

                    if let dueDate = task.dueDate {
                        Text("• \(dueDate.formatted(.dateTime.month().day()))")
                            .font(.caption)
                            .foregroundColor(.orange)
                    }
                }
            }

            Spacer()

            Text(task.status.displayName)
                .font(.caption)
                .padding(.horizontal, 8)
                .padding(.vertical, 4)
                .background(task.status.color.opacity(0.2))
                .foregroundColor(task.status.color)
                .cornerRadius(8)

            if task.status == .pending {
                Button(action: {
                    taskManager.startTask(task.id)
                }) {
                    Image(systemName: "play.circle.fill")
                        .foregroundColor(.blue)
                }
            }
        }
        .padding(.horizontal, 12)
        .padding(.vertical, 8)
        .background(.gray.opacity(0.05))
        .cornerRadius(8)
    }
}

struct TasksListView: View {
    @ObservedObject var taskManager: TaskManager
    @State private var showingAddTask = false

    var body: some View {
        NavigationView {
            List {
                ForEach(taskManager.tasks.filter { !$0.isArchived }) { task in
                    TaskDetailRow(task: task, taskManager: taskManager)
                }
                .onDelete(perform: deleteTasks)
            }
            .navigationTitle("所有任务")
            .toolbar {
                ToolbarItem(placement: .primaryAction) {
                    Button(action: {
                        showingAddTask = true
                    }) {
                        Image(systemName: "plus")
                    }
                }
            }
            .sheet(isPresented: $showingAddTask) {
                WorkingAddTaskView(taskManager: taskManager)
            }
        }
    }

    private func deleteTasks(offsets: IndexSet) {
        let tasksToDelete = offsets.map { taskManager.tasks[$0] }
        for task in tasksToDelete {
            taskManager.deleteTask(task)
        }
    }
}

struct TaskDetailRow: View {
    let task: TodoTask
    @ObservedObject var taskManager: TaskManager

    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            HStack {
                Text(task.title)
                    .font(.headline)
                    .fontWeight(.medium)

                Spacer()

                Text(task.status.displayName)
                    .font(.caption)
                    .padding(.horizontal, 8)
                    .padding(.vertical, 4)
                    .background(task.status.color.opacity(0.2))
                    .foregroundColor(task.status.color)
                    .cornerRadius(8)
            }

            if !task.description.isEmpty {
                Text(task.description)
                    .font(.subheadline)
                    .foregroundColor(.secondary)
                    .lineLimit(2)
            }

            HStack {
                Label(task.estimatedDuration.shortFormattedTime, systemImage: "clock")
                    .font(.caption)
                    .foregroundColor(.secondary)

                if let dueDate = task.dueDate {
                    Label(dueDate.formatted(.dateTime.month().day().hour().minute()), systemImage: "calendar")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }

                if task.repeatType != .none {
                    Label(task.repeatType.displayName, systemImage: "repeat")
                        .font(.caption)
                        .foregroundColor(.blue)
                }

                Spacer()

                if task.status == .pending {
                    Button("开始") {
                        taskManager.startTask(task.id)
                    }
                    .font(.caption)
                    .padding(.horizontal, 12)
                    .padding(.vertical, 4)
                    .background(.blue)
                    .foregroundColor(.white)
                    .cornerRadius(12)
                } else if task.status == .inProgress {
                    Button("暂停") {
                        taskManager.pauseTask(task.id)
                    }
                    .font(.caption)
                    .padding(.horizontal, 12)
                    .padding(.vertical, 4)
                    .background(.orange)
                    .foregroundColor(.white)
                    .cornerRadius(12)
                } else if task.status == .paused {
                    Button("继续") {
                        taskManager.resumeTask(task.id)
                    }
                    .font(.caption)
                    .padding(.horizontal, 12)
                    .padding(.vertical, 4)
                    .background(.blue)
                    .foregroundColor(.white)
                    .cornerRadius(12)
                }
            }
        }
        .padding(.vertical, 4)
    }
}

struct AnalyticsView: View {
    @ObservedObject var taskManager: TaskManager

    var body: some View {
        NavigationView {
            ScrollView {
                VStack(spacing: 24) {
                    // Productivity Score
                    VStack(spacing: 16) {
                        Text("今日生产力评分")
                            .font(.headline)
                            .fontWeight(.semibold)

                        ZStack {
                            Circle()
                                .stroke(lineWidth: 15)
                                .opacity(0.1)
                                .foregroundColor(.blue)

                            Circle()
                                .trim(from: 0.0, to: CGFloat(max(0, min(1, taskManager.dailyStats.productivityScore / 100))))
                                .stroke(style: StrokeStyle(lineWidth: 15, lineCap: .round))
                                .foregroundColor(.blue)
                                .rotationEffect(Angle(degrees: 270.0))
                                .animation(.easeInOut(duration: 1.0), value: taskManager.dailyStats.productivityScore)

                            VStack {
                                Text("\(Int(taskManager.dailyStats.productivityScore))")
                                    .font(.system(size: 32, weight: .bold))
                                    .foregroundColor(.blue)

                                Text("分")
                                    .font(.subheadline)
                                    .foregroundColor(.secondary)
                            }
                        }
                        .frame(width: 150, height: 150)
                    }

                    // Stats Grid
                    LazyVGrid(columns: [
                        GridItem(.flexible()),
                        GridItem(.flexible())
                    ], spacing: 16) {
                        AnalyticsCard(
                            title: "完成任务",
                            value: "\(taskManager.dailyStats.totalTasksCompleted)",
                            color: .green
                        )

                        AnalyticsCard(
                            title: "工作效率",
                            value: "\(Int(taskManager.dailyStats.efficiency * 100))%",
                            color: .blue
                        )

                        AnalyticsCard(
                            title: "完成率",
                            value: "\(Int(taskManager.dailyStats.completionRate * 100))%",
                            color: .orange
                        )

                        AnalyticsCard(
                            title: "逾期任务",
                            value: "\(taskManager.dailyStats.overdueTasks)",
                            color: .red
                        )
                    }

                    // Time Breakdown
                    VStack(spacing: 16) {
                        Text("时间分析")
                            .font(.headline)
                            .fontWeight(.semibold)

                        VStack(spacing: 12) {
                            TimeBreakdownRow(
                                label: "已完成工作",
                                time: taskManager.todaysCompletedWork,
                                color: .green
                            )

                            TimeBreakdownRow(
                                label: "剩余工作",
                                time: taskManager.todaysRemainingWorkload,
                                color: .blue
                            )

                            TimeBreakdownRow(
                                label: "空闲时间",
                                time: taskManager.todaysFreeTime,
                                color: .orange
                            )
                        }
                    }

                    Spacer()
                }
                .padding()
            }
            .navigationTitle("分析")
        }
    }
}

struct AnalyticsCard: View {
    let title: String
    let value: String
    let color: Color

    var body: some View {
        VStack(spacing: 8) {
            Text(value)
                .font(.title2)
                .fontWeight(.bold)
                .foregroundColor(color)

            Text(title)
                .font(.subheadline)
                .foregroundColor(.secondary)
        }
        .frame(maxWidth: .infinity)
        .padding()
        .background(color.opacity(0.1))
        .cornerRadius(12)
    }
}

struct TimeBreakdownRow: View {
    let label: String
    let time: TimeInterval
    let color: Color

    var body: some View {
        HStack {
            Text(label)
                .font(.subheadline)

            Spacer()

            Text(time.shortFormattedTime)
                .font(.subheadline)
                .fontWeight(.medium)
                .foregroundColor(color)
        }
        .padding(.horizontal, 16)
        .padding(.vertical, 12)
        .background(color.opacity(0.1))
        .cornerRadius(8)
    }
}

struct WorkingAddTaskView: View {
    @Environment(\.dismiss) private var dismiss
    @ObservedObject var taskManager: TaskManager

    @State private var title = ""
    @State private var description = ""
    @State private var estimatedHours = 1.0
    @State private var estimatedMinutes = 0.0
    @State private var hasDueDate = false
    @State private var dueDate = Date()
    @State private var priority = 0
    @State private var repeatType: RepeatType = .none
    @State private var repeatInterval = 1.0

    var body: some View {
        NavigationView {
            Form {
                Section("基本信息") {
                    TextField("任务标题", text: $title)
                    TextField("描述 (可选)", text: $description, axis: .vertical)
                        .lineLimit(2...4)
                }

                Section("时间设置") {
                    VStack(alignment: .leading, spacing: 12) {
                        Text("预计用时")
                            .font(.subheadline)
                            .foregroundColor(.secondary)

                        HStack {
                            VStack {
                                Text("小时")
                                    .font(.caption)
                                Stepper("\(Int(estimatedHours))", value: $estimatedHours, in: 0...8)
                                    .labelsHidden()
                            }

                            VStack {
                                Text("分钟")
                                    .font(.caption)
                                Stepper("\(Int(estimatedMinutes))", value: $estimatedMinutes, in: 0...59, step: 15)
                                    .labelsHidden()
                            }
                        }

                        Text("总计: \(totalTime)")
                            .font(.caption)
                            .foregroundColor(.blue)
                    }

                    Toggle("设置截止时间", isOn: $hasDueDate)

                    if hasDueDate {
                        DatePicker("截止时间", selection: $dueDate, displayedComponents: [.date, .hourAndMinute])
                    }
                }

                Section("重复设置") {
                    Picker("重复类型", selection: $repeatType) {
                        ForEach(RepeatType.allCases, id: \.self) { type in
                            Text(type.displayName).tag(type)
                        }
                    }
                    .pickerStyle(.menu)

                    if repeatType == .custom {
                        HStack {
                            Text("每")
                            Stepper("\(Int(repeatInterval))", value: $repeatInterval, in: 1...365, step: 1)
                                .labelsHidden()
                            Text("天重复")
                        }
                    }
                }

                Section("优先级") {
                    Picker("优先级", selection: $priority) {
                        HStack {
                            Circle()
                                .fill(.green)
                                .frame(width: 8, height: 8)
                            Text("低")
                        }.tag(0)

                        HStack {
                            Circle()
                                .fill(.orange)
                                .frame(width: 8, height: 8)
                            Text("中")
                        }.tag(1)

                        HStack {
                            Circle()
                                .fill(.red)
                                .frame(width: 8, height: 8)
                            Text("高")
                        }.tag(2)
                    }
                    .pickerStyle(.segmented)
                }
            }
            .navigationTitle("新建任务")
            .toolbar {
                ToolbarItem(placement: .cancellationAction) {
                    Button("取消") {
                        dismiss()
                    }
                }

                ToolbarItem(placement: .primaryAction) {
                    Button("创建") {
                        saveTask()
                    }
                    .disabled(title.isEmpty)
                }
            }
        }
    }

    private var totalTime: String {
        let totalSeconds = estimatedHours * 3600 + estimatedMinutes * 60
        return TimeInterval(totalSeconds).shortFormattedTime
    }

    private func saveTask() {
        let estimatedDuration = estimatedHours * 3600 + estimatedMinutes * 60
        let task = TodoTask(
            title: title,
            description: description,
            estimatedDuration: estimatedDuration,
            dueDate: hasDueDate ? dueDate : nil,
            repeatType: repeatType,
            repeatInterval: Int(repeatInterval),
            priority: priority
        )
        taskManager.addTask(task)
        dismiss()
    }
}

#Preview {
    WorkingContentView()
}